@page "/loans"
@using CollectionManagementBlazor.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Loans</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>Loan Management</h1>
        <p>Track and manage all loan accounts</p>
    </div>

    @if (loans == null)
    {
        <div class="text-center p-4">
            <div class="loading-spinner"></div>
            <p class="mt-3">Loading loans...</p>
        </div>
    }
    else if (!loans.Any())
    {
        <div class="alert-modern info">
            <h5>No Loans Found</h5>
            <p>No loans are currently in the system.</p>
        </div>
    }
    else
    {
        <!-- Dashboard Metrics -->
        <div class="dashboard-grid">
            <div class="metric-card success">
                <div class="metric-label">Total Portfolio</div>
                <div class="metric-value">₹@GetTotalPortfolio().ToString("N0")</div>
                <span class="metric-change positive">@loans.Count accounts</span>
            </div>
            <div class="metric-card warning">
                <div class="metric-label">Outstanding Balance</div>
                <div class="metric-value">₹@GetTotalOutstanding().ToString("N0")</div>
                <span class="metric-change neutral">@((GetTotalOutstanding() / GetTotalPortfolio() * 100).ToString("F1"))% of portfolio</span>
            </div>
            <div class="metric-card info">
                <div class="metric-label">Current Loans</div>
                <div class="metric-value">@GetCurrentLoansCount()</div>
                <span class="metric-change positive">Performing well</span>
            </div>
            <div class="metric-card critical">
                <div class="metric-label">Delinquent Loans</div>
                <div class="metric-value">@GetDelinquentLoansCount()</div>
                <span class="metric-change negative">Needs attention</span>
            </div>
        </div>

        <!-- Loans Table -->
        <div class="data-table-container">
            <div class="table-header">
                <h3>All Loan Accounts</h3>
                <div class="table-actions">
                    <input type="text" class="search-box" placeholder="Search loans..." @bind="searchTerm" @bind:event="oninput" />
                    <select class="search-box" style="width: 150px;" @bind="statusFilter">
                        <option value="">All Status</option>
                        <option value="Current">Current</option>
                        <option value="Delinquent">Delinquent</option>
                        <option value="PaidOff">Paid Off</option>
                    </select>
                    <button class="btn btn-modern btn-secondary">
                        <span class="oi oi-data-transfer-download"></span> Export
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Account #</th>
                            <th>Borrower</th>
                            <th>Loan Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var loan in GetFilteredLoans())
                        {
                            <tr>
                                <td><strong>@loan.AccountNumber</strong></td>
                                <td>@loan.BorrowerName</td>
                                <td>@loan.LoanAmount.ToString("C")</td>
                                <td>@loan.Balance.ToString("C")</td>
                                <td>
                                    <span class="modern-badge @GetStatusBadgeClass(loan.Status)">@loan.Status</span>
                                </td>
                                <td>@loan.DueDate.ToShortDateString()</td>
                                <td>
                                    <button class="btn btn-modern btn-sm btn-primary" @onclick="() => ViewDetails(loan.Id)">
                                        <span class="oi oi-eye"></span> View
                                    </button>
                                    <button class="btn btn-modern btn-sm btn-warning" @onclick="() => EditLoan(loan.Id)">
                                        <span class="oi oi-pencil"></span> Edit
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Loan> loans = new();
    private string searchTerm = string.Empty;
    private string statusFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // TODO: Replace with actual API call when endpoint is available
        await Task.Delay(500); // Simulate loading

        loans = new List<Loan>
        {
            new Loan
            {
                Id = 1,
                AccountNumber = "LN-001",
                BorrowerName = "John Doe",
                LoanAmount = 50000,
                Balance = 45000,
                Status = "Current",
                DueDate = DateTime.Now.AddDays(15)
            },
            new Loan
            {
                Id = 2,
                AccountNumber = "LN-002",
                BorrowerName = "Jane Smith",
                LoanAmount = 75000,
                Balance = 30000,
                Status = "Current",
                DueDate = DateTime.Now.AddDays(7)
            },
            new Loan
            {
                Id = 3,
                AccountNumber = "LN-003",
                BorrowerName = "Robert Johnson",
                LoanAmount = 100000,
                Balance = 95000,
                Status = "Delinquent",
                DueDate = DateTime.Now.AddDays(-5)
            },
            new Loan
            {
                Id = 4,
                AccountNumber = "LN-004",
                BorrowerName = "Mary Williams",
                LoanAmount = 60000,
                Balance = 40000,
                Status = "Current",
                DueDate = DateTime.Now.AddDays(20)
            },
            new Loan
            {
                Id = 5,
                AccountNumber = "LN-005",
                BorrowerName = "James Brown",
                LoanAmount = 80000,
                Balance = 0,
                Status = "PaidOff",
                DueDate = DateTime.Now.AddDays(-30)
            }
        };
    }

    private List<Loan> GetFilteredLoans()
    {
        var filtered = loans.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(l =>
                l.AccountNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                l.BorrowerName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            filtered = filtered.Where(l => l.Status == statusFilter);
        }

        return filtered.ToList();
    }

    private decimal GetTotalPortfolio()
    {
        return loans.Sum(l => l.LoanAmount);
    }

    private decimal GetTotalOutstanding()
    {
        return loans.Sum(l => l.Balance);
    }

    private int GetCurrentLoansCount()
    {
        return loans.Count(l => l.Status == "Current");
    }

    private int GetDelinquentLoansCount()
    {
        return loans.Count(l => l.Status == "Delinquent");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Current" => "success",
            "Delinquent" => "danger",
            "PaidOff" => "info",
            _ => "pending"
        };
    }

    private void ViewDetails(int id)
    {
        NavigationManager.NavigateTo($"/loans/{id}");
    }

    private void EditLoan(int id)
    {
        NavigationManager.NavigateTo($"/loans/{id}");
    }

    private class Loan
    {
        public int Id { get; set; }
        public string AccountNumber { get; set; } = string.Empty;
        public string BorrowerName { get; set; } = string.Empty;
        public decimal LoanAmount { get; set; }
        public decimal Balance { get; set; }
        public string Status { get; set; } = string.Empty;
        public DateTime DueDate { get; set; }
    }
}
