@page "/loans"
@using CollectionManagementBlazor.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Loans</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>Loan Management</h1>
        <p>Track and manage all loan accounts</p>
    </div>

    @if (loans == null)
    {
        <div class="text-center p-4">
            <div class="loading-spinner"></div>
            <p class="mt-3">Loading loans...</p>
        </div>
    }
    else if (!loans.Any())
    {
        <div class="alert-modern info">
            <h5>No Loans Found</h5>
            <p>No loans are currently in the system.</p>
        </div>
    }
    else
    {
        <!-- Dashboard Metrics -->
        <div class="dashboard-grid">
            <div class="metric-card success">
                <div class="metric-label">Total Portfolio</div>
                <div class="metric-value">₹@GetTotalPortfolio().ToString("N0")</div>
                <span class="metric-change positive">@loans.Count accounts</span>
            </div>
            <div class="metric-card warning">
                <div class="metric-label">Outstanding Balance</div>
                <div class="metric-value">₹@GetTotalOutstanding().ToString("N0")</div>
                <span class="metric-change neutral">@((GetTotalOutstanding() / GetTotalPortfolio() * 100).ToString("F1"))% of portfolio</span>
            </div>
            <div class="metric-card info">
                <div class="metric-label">Current Loans</div>
                <div class="metric-value">@GetCurrentLoansCount()</div>
                <span class="metric-change positive">Performing well</span>
            </div>
            <div class="metric-card critical">
                <div class="metric-label">Delinquent Loans</div>
                <div class="metric-value">@GetDelinquentLoansCount()</div>
                <span class="metric-change negative">Needs attention</span>
            </div>
        </div>

        <!-- Loans Table -->
        <div class="data-table-container">
            <div class="table-header">
                <h3>All Loan Accounts</h3>
                <div class="table-actions">
                    <input type="text" class="search-box" placeholder="Search loans..." @bind="searchTerm" @bind:event="oninput" />
                    <select class="search-box" style="width: 150px;" @bind="statusFilter">
                        <option value="">All Status</option>
                        <option value="Current">Current</option>
                        <option value="Delinquent">Delinquent</option>
                        <option value="PaidOff">Paid Off</option>
                    </select>
                    <button class="btn btn-modern btn-secondary">
                        <span class="oi oi-data-transfer-download"></span> Export
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Account #</th>
                            <th>Borrower</th>
                            <th>Loan Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var loan in GetFilteredLoans())
                        {
                            <tr>
                                <td><strong>@loan.AccountNumber</strong></td>
                                <td>@loan.BorrowerName</td>
                                <td>@loan.LoanAmount.ToString("C")</td>
                                <td>@loan.Balance.ToString("C")</td>
                                <td>
                                    <span class="modern-badge @GetStatusBadgeClass(loan.Status)">@loan.Status</span>
                                </td>
                                <td>@loan.DueDate.ToShortDateString()</td>
                                <td>
                                    <button class="btn btn-modern btn-sm btn-primary" @onclick="() => ViewDetails(loan.Id)">
                                        <span class="oi oi-eye"></span> View
                                    </button>
                                    <button class="btn btn-modern btn-sm btn-warning" @onclick="() => EditLoan(loan.Id)">
                                        <span class="oi oi-pencil"></span> Edit
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Loan> loans = new();
    private string searchTerm = string.Empty;
    private string statusFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<LoanApiDTO>>>("api/loans");
            if (response?.Success == true && response.Data != null)
            {
                loans = response.Data.Select(l => new Loan
                {
                    Id = (int)l.Id,
                    AccountNumber = l.AccountNumber,
                    BorrowerName = l.BorrowerName,
                    LoanAmount = l.DisbursedAmount,
                    Balance = l.OutstandingAmount,
                    Status = l.Status,
                    DueDate = l.NextDueDate ?? DateTime.Now
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading loans: {ex.Message}");
            loans = new List<Loan>();
        }
    }

    private List<Loan> GetFilteredLoans()
    {
        var filtered = loans.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(l =>
                l.AccountNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                l.BorrowerName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            filtered = filtered.Where(l => l.Status == statusFilter);
        }

        return filtered.ToList();
    }

    private decimal GetTotalPortfolio()
    {
        return loans.Sum(l => l.LoanAmount);
    }

    private decimal GetTotalOutstanding()
    {
        return loans.Sum(l => l.Balance);
    }

    private int GetCurrentLoansCount()
    {
        return loans.Count(l => l.Status == "Current");
    }

    private int GetDelinquentLoansCount()
    {
        return loans.Count(l => l.Status == "Delinquent");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Current" => "success",
            "Delinquent" => "danger",
            "PaidOff" => "info",
            _ => "pending"
        };
    }

    private void ViewDetails(int id)
    {
        NavigationManager.NavigateTo($"/loans/{id}");
    }

    private void EditLoan(int id)
    {
        NavigationManager.NavigateTo($"/loans/{id}");
    }

    private class Loan
    {
        public int Id { get; set; }
        public string AccountNumber { get; set; } = string.Empty;
        public string BorrowerName { get; set; } = string.Empty;
        public decimal LoanAmount { get; set; }
        public decimal Balance { get; set; }
        public string Status { get; set; } = string.Empty;
        public DateTime DueDate { get; set; }
    }

    private class LoanApiDTO
    {
        public long Id { get; set; }
        public string AccountNumber { get; set; } = string.Empty;
        public string BorrowerName { get; set; } = string.Empty;
        public string ProductType { get; set; } = string.Empty;
        public decimal DisbursedAmount { get; set; }
        public decimal OutstandingAmount { get; set; }
        public int DPD { get; set; }
        public string Status { get; set; } = string.Empty;
        public DateTime? NextDueDate { get; set; }
    }

    private class ApiResponse<T>
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public T? Data { get; set; }
    }
}
